---
author: "Francisco José Lozano Ruiz"
date: "27/10/2017"
documentclass: book
forprint: true  # true: imprime a dos caras, false: libro digital
fontsize: 12pt # 10pt,11pt
geometry: margin = 2.5cm 
bibliography: ["bib/library.bib", "bib/paquetes.bib"]
# metodobib -> true: natbib (descomentar: citation_package: natbib) 
#           -> false: pandoc (comentar: citation_package: natbib)
metodobib: true
#natbib: plainnat, abbrvnat, unsrtnat
biblio-style: "plainnat"
#Método 2 (pandoc): descomente una línea de las 2 siguientes en caso de usarlo
csl: methods-in-ecology-and-evolution.csl      # no numera mejor en las citas
#csl: acm-sig-proceedings-long-author-list.csl  # numera peor en las citas
link-citations: yes
output: 
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib  # comentado usa: pandoc-citeproc
    #toc: yes
    fig_caption: yes
    template: latex/templateMemoriaTFE.tex
    includes:
      #before_body: portadas/latex_paginatitulo_modTFE.tex
      #in_header: latex/latex_preambulo.tex
      #after_body: latex/latex_antes_enddoc.tex
---


```{r include=FALSE}
#Sys.setlocale('LC_ALL','C') # corrige problema con 
options(kableExtra.latex.load_packages = F)
#options(tinytex.latexmk.emulation = FALSE)
knitr::opts_chunk$set(fig.path = 'figurasR/',
                      echo = FALSE, warning = FALSE, message = FALSE,
                      fig.pos="H",fig.align="center",out.width="95%",
                      cache=FALSE)
knitr::write_bib(c("knitr","rmarkdown","dplyr","ggplot2","kableExtra"),
                 file="bib/paquetes.bib", width = 60)
```


<!-- \setcounter{chapter}{2} -->
<!-- \setcounter{chapter}{2} escribir 2 para capítulo 3  -->
<!-- \pagenumbering{arabic} -->


\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents
<!-- \subpdfbookmark{Índice General}{indice} -->
\nocite{Luque2017,Luque2019,RStudio,R-base,
R-knitr,R-rmarkdown,R-dplyr,R-ggplot2,Techopedia}

\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi

\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

# Aplicación de los MAG al análisis del cambio climático

En esta sección nos proponemos el aplicar el contexto teórico visto hasta ahora sobre los modelos aditivos generalizados al análisis del cambio climático. Para ello principalmente utilizaremos el paquete de R: "mgcv" (siglas en inglés de "Vehículo de Computación para MAG Mixtos"), en particular haremos uso de su funcion "gam", la cual permite ajustar modelos aditivos generalizados, entre otros tipos de modelos, mediante splines de regresión penalizados (u smoothers similares) donde los parámetros de suavizado pueden ser estimados por distintos métodos, como por ejempli: mínima validación cruzada generalizada, mínimo AIC, por máxima verosimilitud o por REML (que es la opción por defecto).

Además del método de estimación, esta función también admite otras entradas que indican qué familia de distribuciones exponenciales se utiliza, si las observaciones toman distintos pesos, el método de optimización numérica utilizado, otros parámetros de control de estos métodos para el caso de que los habituales no converjan, etc.

Dividiremos las aplicaciones prácticas de los MAG en tres partes: la primera se centra en modelar la temperatura media mensual según una serie de variables climáticas y ver cómo ha variado con los años, en la siguiente veremos cómo han evolucionado a lo largo del tiempo las concentraciones de gases de efecto invernadero en la atmósfera y algunos de sus efectos, por último estudiaremos la media variacional del nivel del mar respecto del año 1993.

## Modelización de la temperatura media mensual 

### Datos

Para esta primera aplicación de los modelos aditivos generalizados utilizaremos datos de elementos climáticos proporcionados por la Agencia Estatal de Meteorología española (AEMET), para ello utilizaremos la libreria "climaemet" @climaemet:

```{r,echo=TRUE,eval=TRUE}
#install.packages('climaemet')
library(climaemet)
```
Como hemos dicho antes, el conjunto de datos sobre el que trabajaremos a lo largo de esta sección está formado por variables climáticas, estas se definen como elementos que caracterizan el tiempo atmosférico y que interactuan entre sí en la troposfera. Aunque son elementos relacionados con el campo de la meteorología, su estudio a largo plazo, fundamenta las bases científicas de la climatología. En particular, el conjunto de datos mensuales que nos proporciona la anterior librería contiene más de 40 variables climáticas, por comodidad y para una mejor interpretación de los modelos nos quedaremos con las variables que representen la temperatura media mensual, la humedad relativa, la media mensual de precipitaciones y la velocidad media del viento. Otras variables climáticas de interés pueden ser la presión atmosférica y la nubosidad. 

Estos datos provienen de una base de datos _open source_ que ofrece la AEMET y en particular utilizamos las mediciones tomadas por la estación situada en el aeropuerto de Sevilla, se puede leer más sobre ellos en: <https://opendata.aemet.es/centrodedescargas/inicio>. Procedamos con la lectura y limpieza de los datos mensuales desde 1960 a 2023: 

```{r,echo=TRUE,eval=TRUE}
library(tidyr)
library(dplyr)
Clima <- aemet_monthly_period(station = "5783", start = 1960, end = 2023) 
Clima <- Clima %>% separate(fecha, into = c("Año", "Mes"), sep = "-")
Clima$Año <- as.numeric(Clima$Año)
Clima$Mes <- factor(Clima$Mes, levels = as.character(1:12))
Clima <- Clima[,c(1,2,6,11,27,29,32)] # Seleccionamos las variables que nos interesan
colnames(Clima) <- c('Año','Mes','HR','PresM','Prec','WMed','TMedM')
Clima <- Clima %>% arrange(Año, Mes) # Ordenamos por año y mes
Clima <- Clima[complete.cases(Clima$Mes),] # Retiramos las medias anuales
```

Hagamos ahora la primera visualización de ellos observando su estructura y un resumen:

```{r,echo=TRUE,eval=TRUE}
str(Clima)
```

```{r,echo=TRUE,eval=TRUE}
summary(Clima)
```
\begin{itemize}
  \item HR: la humedad relativa media es un valor porcentual de la cantidad de vapor de agua presente en el aire con respecto a la máxima posible para unas condiciones dadas de presión y temperatura.
  \item PresM: la presión media mensual al nivel de la estación.
  \item Prec: la precipitación total mensual medida en milímetros.
  \item WMed: la velocidad media del aire se mide en metros por segundo. 
  \item TMedM: la temperatura media mensual viene dada en grados centígrados. 
\end{itemize}

### Descripción del modelo 

Tomaremos a la variable *TMedM* como variable de respuesta y al resto como variables explicativas.
Antes de definir el modelo debemos notar que la variable *Año* no se ha definido como variable categórica, como sí se hizo para la variable *Mes*, sino que se define como variable numérica para luego poder tener una mejor representación de los resultados obtenidos. Además, si se hubiera definido de tal forma, resultaría que la mayoría de factores son no significativos. Dicho esto definimos el modelo como:

```{r,echo=TRUE,eval=TRUE}
#install.packages('mgcv')
library(mgcv)
```

```{r,echo=TRUE,eval=TRUE}
mag1 <- gam(TMedM~ s(HR)+s(PresM)+s(Prec)+s(WMed)+Año+Mes,data = Clima)
summary(mag1)
```
Como podemos ver en el resumen del modelo, se toma por defecto que la variable dependiente sigue la distribución normal y que la función de enlace es la identidad. Se obtiene que el modelo es capaz de explicar el 96.3% de la varianza con $R^2_{adj}=0.962$. Se tiene también que todas las variables predictoras son significativas. Observemos qué efecto tienen las variables predictoras sobre la temperatura media mensual:

```{r,echo=FALSE,eval=TRUE}
par(mfrow = c(2, 2))
plot(mag1, select = 1, main = 'Humedad Relativa', shade = TRUE)
plot(mag1, select = 2, main = 'Presion', shade = TRUE)
plot(mag1, select = 3, main = 'Precipitaciones totales', shade = TRUE)
plot(mag1, select = 4, main = 'Velocidad media del viento', shade = TRUE)
par(mfrow = c(1, 1))
```
De las gráficas de la derecha se puede interpretar que los efectos de *PresM* y *WMed* sobre la temperatura media mensual son lineales. Ajustamos entonces un nuevo modelo aditivo generalizado del mismo modo que antes pero imponiendo que el efecto de estas variables sea lineal:

```{r,echo=TRUE,eval=TRUE}
mag2 <- gam(TMedM~ s(HR)+PresM+s(Prec)+WMed+Año+Mes,data = Clima)
summary(mag2)
```

Podemos ver que tanto la desviación explicada como la estimación del error por validación cruzada coinciden con las del modelo anterior, sin embargo utilizaremos la función *anova* para dar una prueba de razón de verosimilitud que determine si el modelo más complejo mejora significativamente el ajuste.

```{r,echo=TRUE,eval=TRUE}
anova(mag1,mag2,test = "F")
```
Como el p-valor resultante del contraste de hipótesis es $>0.05$, no tenemos evidencias significativas como para rechazar la hipótesis nula, es decir, se acepta que ambos modelos tienen el mismo ajuste.

También es posible compararlos mediante otros criterios, por ejemplo el AIC (Akaike Information Criterion) que tiene en cuenta el número de parámetros a estimar y el valor objetivo de la función de log-verosimilitud:
```{r,echo=TRUE,eval=TRUE}
AIC(mag1,mag2)
```
En este caso son casi idénticos, aunque el primer modelo tiene menor AIC. 

Para obtener más información sobre el modelo planteado se utiliza la siguiente rutina de diagnósticos que nos proporciona información y gráficos útiles para evaluar la calidad del ajuste del modelo.

```{r, eval=TRUE, warning=FALSE,echo=TRUE}
gam.check(mag1)
```

Por un lado, la salida por consola nos informa de que se obtiene la convergencia por optimización del GCV y que el modelo es de rango completo. Los p-valores que aparecen se corresponden a los tests de residuos aleatorios correspondientes para cada predictor, en este caso todos excepto el asociado a *Prec* son $<0.05$, lo que indica que los residuos no están distribuidos aleatoriamente y que se necesitaría una base de funciones de mayor dimensión. 
Por otro lado, observemos qué representa cada una de las gráficas generadas y cuál sería el caso ideal para cada una de ellas:

\begin{itemize}
  \item Q-Q Plot: compara la distribución de los residuos con una distribución normal. Lo ideal es que los puntos se alineen aproximadamente en una línea recta.
  \item Resids vs. linear pred: representa los residuos contra el predictor lineal, ayuda a verificar si los residuos se distribuyen aleatoriamente, que sería lo ideal.
  \item Histogram of residuals: se trata de un histograma de los residuos, en este caso lo ideal es que muestre una distribución aproximadamente normal, centrada en cero, esto indicaría que los residuos no presentan sesgos significativos.
  \item Response vs. Fitted Values: representa los valores observados frente a los valores ajustados, lo ideal sería que los puntos resultantes se aconglomerasen en torno a la recta $x=y$.
\end{itemize}

Por lo general este modelo se comporta de manera decente, ya que se aproxima mucho a los casos ideales de cada gráfica. Podemo utilizar la librería *visibly* de @M-Clark para hacer esta representación de forma más clara:

```{r,echo=TRUE,eval=TRUE}
#install.packages('visibly')
library(visibly)
plot_gam_check(mag1)
```


### Visualización de los resultados

Una vez generado el modelo y comprobado que se tiene una bondad de ajuste decente, veamos cómo ajusta los datos para poder visualizar si se ha producido un cambio significativo en la temperatura media mensual a lo largo de los años. 

```{r,echo=TRUE,eval=TRUE, warning=FALSE}
Julio <- filter(Clima, Clima$Mes == 7)
Julio$Preds <- predict(mag1, newdata = Julio)
Julio <- Julio[complete.cases(Julio$Preds),]

lm1 <- gam(TMedM ~ Año,data = Julio)
Julio$LPreds <- predict(lm1,Julio)

library(ggplot2)
ggplot(Julio,aes(x=Año))+
  geom_point(aes(y=TMedM),size=1.5,col = 'black')+
  theme_minimal()+
  geom_line(aes(y=Preds),linewidth=1,col = 'darkred')+
  geom_line(aes(y=LPreds),linewidth=0.6,col = '#EB6146')+
  labs(title ="Temperatura media mensual del mes de Julio",x="Año",y="Temperatura ºC",
       legend = c('MAG1','Modelo Lineal'))+
  theme(axis.title = element_text(face = "italic"),
        legend.text = element_text( size = 10,colour = "black"),
        legend.title = element_blank(),legend.position = c(0.5,0.9))
```

Con esta gráfica podemos apreciar claramente como la temperatura media en el mes de Julio ha ido aumentado con el paso de los años en la estación meteorológica del aeropuerto de San Pablo. Hemos introducido la recta proporcionada por el modelo lineal para los datos de los meses de Julio para tener una mejor apreciación de tal incremento.

## Modelización de gases de efecto invernadero 

### Descripción de los datos

En esta sección ajustaremos modelos aditivos generalizados para estudiar la concentración atmosférica de gases de efecto invernadero, en particular analizaremos las medias mensuales globales de las concentraciones de dióxido de carbono ($CO_2$), Metano ($CH_4$) y óxido nitroso ($N_2O$). Para ello consideraremos los datos proporcionados por United Nations Environment Programme (UNEP), para el $CO_2$ se obtienen en <https://wesr.unep.org/climate/essential-climate-variables-ecv/atmospheric-co2-concentration> y para los dos siguientes en <https://wesr.unep.org/climate/essential-climate-variables-ecv/atmospheric-ch4-n2o-sf6-concentration>.

Ya hablamos sobre las emisiones de gases contaminantes en \ref{Resumen del cambio climático en la actualidad} pero no se llego a definir en qué consistían. Estos gases son capaces de absorber y emitir radiación dentro del espectro inflarrojo y, por tanto son capaces de retener el calor del Sol, lo que permite que el clima terrestre sea habitable para la humanidad. Sin embargo, desde el inicio de la revolución industrial, la actividad humana ha producido un desequilibrio en los niveles de concentración de estos gases en la atmósfera. En particular estudiaremos las concentraciones de los tres tipos de gases antes mencionads por ser las que se emiten en mayor cantidad o por ser las más potentes (en términos de contribución al efecto invernadero). Por ejemplo, las emisiones de $CO_2$ se corresponden aproximadamente con tres cuartas partes del total de emisiones y tarda en descomponerse en la atmósfera más de 100 años, sin embargo el $CH_4$ y el $N_2O$ representan una parte mucho menor que el dióxido de carbono pero por unidad son mucho más potentes como gases de efecto invernadero.



Hagamos ahora una primera visualización de los datos. Para tener una mejor lectura de los datos, primero debemos transformar el archivo *.xlsx*, luego utilizamos la librería *readxl* para leerlo y la librería *lubridate* para obtener la fecha:

```{r,echo = TRUE,eval=TRUE}
library(readxl)
library(lubridate)
```
\begin{itemize}
\item $CO_2$:
\end{itemize}
```{r,echo=TRUE,eval=TRUE}
CO2 <- read_excel('trends-in-atmospheric-carbon-dioxide-concentration.xlsx')

CO2$DateTime <- as.Date(CO2$DateTime) # Creamos las variables año y mes como categoricas
CO2$Año <- as.numeric(year(CO2$DateTime))
CO2$Mes <- factor(month(CO2$DateTime),levels = as.character(1:12))
CO2$Tmes <- as.numeric(CO2$'Monthly Data')
CO2$Trend <- as.numeric(CO2$'Trend')
CO2 <- CO2[,c(4,5,6,3)]
CO2 <- CO2 %>% arrange(Año, Mes) # Ordenamos por año y mes
```
De este modo nos queda un data frame con 794 observaciones, correspondientes a los meses desde marzo del 1958 hasta abril de 2024, y con las variables *Año*, *Mes*, *Tmes* que se corresponde con la concentración media de $CO_2$ a nivel global medida en partes por millón (ppm) y *Trend* que es la media anual de las anteriores. 1 ppm significa que existe una molécula de ese gas por cada millón de moléculas de aire.

```{r,echo=TRUE,eval=TRUE}
str(CO2)
```
```{r,echo=TRUE,eval=TRUE}
summary(CO2)
```
\begin{itemize}
\item $CH_4$:
\end{itemize}
```{r,echo=TRUE,eval=TRUE}
CH4 <- read_excel('trends-in-atmospheric-methane-concentration.xlsx')

CH4$DateTime <- as.Date(CH4$DateTime) # Creamos las variables año y mes 
CH4$Año <- as.numeric(year(CH4$DateTime))
CH4$Mes <- factor(month(CH4$DateTime),levels = as.character(1:12))
CH4$Trend <- as.numeric(CH4$'Trend')
CH4 <- CH4[,c(3,4,2)]
CH4 <- CH4 %>% arrange(Año, Mes) # Ordenamos por año y mes
```

En este caso disponemos de 487 observaciones correspondientes a meses entre 1983 y 2024, las variables de tiempo *Año* y *Mes* y la variable *Trend* la cual representa la media mensual de concentración de metano a nivel global medida en partes por billón (ppb).

```{r,echo=TRUE,eval=TRUE}
str(CH4)
```
```{r,echo=TRUE,eval=TRUE}
summary(CH4)
```
\begin{itemize}
\item $N_2O$:
\end{itemize}
```{r,echo=TRUE,eval=TRUE}
N2O <- read_excel('trends-in-atmospheric-nitrous-oxide-concentration.xlsx')

N2O$DateTime <- as.Date(N2O$DateTime) # Creamos las variables año y mes 
N2O$Año <- as.numeric(year(N2O$DateTime))
N2O$Mes <- factor(month(N2O$DateTime),levels = as.character(1:12))
N2O$Trend <- as.numeric(N2O$'Trend')
N2O <- N2O[,c(3,4,2)]
N2O <- N2O %>% arrange(Año, Mes) # Ordenamos por año y mes
```

Para el caso del óxido nitroso sólo disponemos datos desde el 2001, por lo que obtenemos un conjunto de 277 observaciones para las variables *Año*, *Mes* y *Trend* que representa la media mensual de concentración de $N_2O$ a nivel global medida en partes por billón (ppb). 

```{r,echo=TRUE,eval=TRUE}
str(N2O)
```
```{r,echo=TRUE,eval=TRUE}
summary(N2O)
```

Solo con los resúmenes de los datos para los tres gases, teniendo en cuenta las medidas en las que vienen dados, ya se puede ver la gran diferencia que hay entre sus proporciones en la atmósfera.

### Descripción de los modelos

Partiremos definiendo un modelo aditivo generalizado para los datos de $CO_2$ que tenga como variable de respuesta la media mesual global de la concentración de este gas medida en ppm y como predictoras las variables *Año* y *Mes*:

```{r,echo=TRUE,eval=TRUE}
magCO2 <- gam(Tmes ~ Año + Mes, data = CO2)
summary(magCO2)
```

Podemos observar que representa un 98.1% de la desviación explicada, por lo que en principio no parece un mal ajuste, comprobémoslo con el diagnóstico de residuos como se hizo en el apartado anterior:
```{r,echo=TRUE,eval=TRUE}
plot_gam_check(magCO2)
```

Gracias a estos gráfios se puede ver cómo el modelo falla en varios aspectos: 
\begin{itemize}
  \item Se puede ver claramente que el Q-Q plot no se adapta a la recta, es decir, la distribución de los residuos no es normal. Además
  \item En la gráfica de arriba a la derecha se puede ver como los residuos toman un patrón claro respecto de los predictores, por lo que los residuos no se distribuyen aleatoriamente.
  \item En la de abajo a la izquierda se ve facilmente no es una distribución normal centrada en el 0.
  \item Por último, el gráfico Response vs. Fitted en general se ajusta bien, pero tiene claros errores.  
\end{itemize}

```{r,echo=TRUE,eval=TRUE}
e <- residuals(magCO2); fv <- fitted(magCO2)
lm(log(e^2) ~ log(fv))
```


```{r,echo=TRUE,eval=TRUE}
magCO2b <- gam(Tmes ~ s(Año) + Mes, data = CO2, family = inverse.gaussian(link = "1/mu^2"))
summary(magCO2b)

magCO2c <- gam(Tmes ~ s(Año) + Mes, data = CO2, family = Gamma(link = "log"))
summary(magCO2c)
```
```{r}
preds <- sqrt(1/predict(magCO2c,CO2))

plot(CO2$Año,CO2$Tmes, xlab = "años",ylab = "Concentracion mensual media de dioxido de carbono (ppm)")
lines(CO2$Año,preds, col = "red", lwd = 2)
```

```{r}
preds <- exp(predict(magCO2c,CO2))

plot(CO2$Año,CO2$Tmes, xlab = "años",ylab = "Concentracion mensual media de dioxido de carbono (ppm)")
lines(CO2$Año,preds, col = "red", lwd = 2)
```