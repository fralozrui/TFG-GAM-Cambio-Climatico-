---
author: "Francisco José Lozano Ruiz"
date: "27/10/2017"
documentclass: book
forprint: true  # true: imprime a dos caras, false: libro digital
fontsize: 12pt # 10pt,11pt
geometry: margin = 2.5cm 
bibliography: ["bib/library.bib", "bib/paquetes.bib"]
# metodobib -> true: natbib (descomentar: citation_package: natbib) 
#           -> false: pandoc (comentar: citation_package: natbib)
metodobib: true
#natbib: plainnat, abbrvnat, unsrtnat
biblio-style: "plainnat"
#Método 2 (pandoc): descomente una línea de las 2 siguientes en caso de usarlo
csl: methods-in-ecology-and-evolution.csl      # no numera mejor en las citas
#csl: acm-sig-proceedings-long-author-list.csl  # numera peor en las citas
link-citations: yes
output: 
  pdf_document:
    keep_tex: no
    number_sections: yes
    citation_package: natbib  # comentado usa: pandoc-citeproc
    #toc: yes
    fig_caption: yes
    template: latex/templateMemoriaTFE.tex
    includes:
      #before_body: portadas/latex_paginatitulo_modTFE.tex
      #in_header: latex/latex_preambulo.tex
      #after_body: latex/latex_antes_enddoc.tex
---



```{r include=FALSE}
knitr::opts_chunk$set(fig.path = 'figurasR/',
                      echo = FALSE, warning = FALSE, message = FALSE,
                      fig.pos="H",fig.align="center",out.width="95%",
                      cache=FALSE)

```


<!-- \setcounter{chapter}{2} -->
<!-- \setcounter{chapter}{2} escribir 2 para capítulo 3  -->
<!-- \pagenumbering{arabic} -->

\ifdefined\ifprincipal
\else
\setlength{\parindent}{1em}
\pagestyle{fancy}
\setcounter{tocdepth}{4}
\tableofcontents
<!-- \nocite{*} -->
\fi

\ifdefined\ifdoblecara
\fancyhead{}{}
\fancyhead[LE,RO]{\scriptsize\rightmark}
\fancyfoot[LO,RE]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[LE,RO]{\footnotesize\thepage}
\else
\fancyhead{}{}
\fancyhead[RO]{\scriptsize\rightmark}
\fancyfoot[LO]{\scriptsize\slshape \leftmark}
\fancyfoot[C]{}
\fancyfoot[RO]{\footnotesize\thepage}
\fi
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

\theoremstyle{remark}
\newtheorem{observación}{Observación}[section]
\theoremstyle{definition}
\newtheorem{definición}{Definición}[section]
\theoremstyle{plain}
\newtheorem{proposición}{Proposición}[section]
\theoremstyle{remark}
\newtheorem{ejemplo}{Ejemplo}[section]

# Modelos aditivos generalizados

## Introducción

Como bien podemos intuir por su nombte, los modelos aditivos generalizados no son más que la fusión entre los modelos lineales generalizados y los modelos aditivos, los cuales se introducen con una sección en este capítulo. Podemos ver estos dos tipos de modelos como extensiones del modelo lineal. Por un lado, como vimos en el capítulo anterior, el MLG hace uso de una función de enlace entre el predictor lineal y el valor esperado de la variable dependiente para poder expresar relaciones más complejas y relaja la hipótesis distribucional permitiendo que tal variable siga distribuciones de la familia exponencial. Por otro lado, los modelos aditivos, además de también relajar esta hipótesis de distribución, introducen las funciones de suavizado en el modelo, estas proporcionan más flexibilidad a la hora de relacionar las variables explicativas con la de respuesta.

Luego, como ya hemos mencionado y como se plantean Hastie y Tibshirani (1986,1990), el MAG reune estas dos propuestas de forma que este tipo de modelo generaliza el modelo aditivo de la misma forma que el MLG generalizaba el modelo lineal. Sin embargo, la flexibilidad que proporciona este modelo da lugar a dos nuevos problemas teóricos: cómo estimar las funciones de suavizado y cómo de "suaves" deben ser. 

Comenzaremos este capítulo viendo como construir los modelos aditivos generalizados, es decir, qué bases de funciones podemos elegir para obtener las funciones de suavizado y qué parámetro de suavizado se debe seleccionar o cómo se puede estimar. Luego se introduce el modelo aditivo, en el que se utilizarán los resultados vistos a lo largo del capítulo. Tras todo ello se propone la forma final del modelo aditivo generalizado.


\begin{definición}[Estructura básica del modelo aditivo generalizado]
$$
\mu = \begin{pmatrix} \mu_1 \\ \vdots \\ \mu_n \end{pmatrix} = 
\begin{pmatrix} E[Y_1] \\ \vdots \\ E[Y_n] \end{pmatrix} = E[Y]
$$
\begin{equation}
g(\mu_i) = A_i\theta + f_1(x_{1i} + f_2(x_{2i}) + f_3(x_{3i},x_{4i}) + \dots  \hspace{0.5cm}, 
\forall i =1,\dots,n
\label{eq:MAG}
\end{equation}
Donde:
\begin{itemize}
  \item $Y_i$ es la variable de respuesta y sigue una distribución de la familia exponencial de media $\mu_i$ y parámetro de escalado $\phi$. A partir de ahora esto lo denotaremos por: $Y_i \backsim EF(\mu_i,\phi)$.
  \item $A_i$ es la fila i-ésima de la matriz del modelo para aquellas componentes del modelo que son estrictamente paramétricas.
  \item $\theta$ es el correspondiente vector de parámetro, que antes denotábamos por $\beta$, para las variables predictoras mencionadas en el anterior punto.
  \item Las $f_i$ son las funciones de suavizado para las covariables $x_k$.
\end{itemize}
\end{definición}


## Suavizado univariante

Dicho esto, partiremos considerando modelos que, aunque no sean adecuados para un uso práctico general, nos permitirán estudiar el marco teórico de una forma más sencilla. Es decir, en esta sección consideraremos un modelo con una sola función de suavizado, $f$, y una sola covariable, $x$, de la forma: 
\begin{equation}
y_i = f(x_i) + \epsilon_i
\label{eq: basic MAG}
\end{equation}
Donde $y_i$ es la variable de respuesta y los $\epsilon_i$ son variables aleatorias independientes e identicamente distribuidas como $N(0,\sigma^2)$ que representan el error.


### Bases de funciones

Nos proponemos en esta sección obtener una estimación de la función de suavizado a partir de una base de un espacio de funciones, en el que también se encontrará $f$ (o una aproximación suya). Elegir una base equivale a tomar un conjunto de funciones $\{b_j(x)\}_{j=1}^k$ y, por tanto, podemos representar la función de suavizado como:
\begin{equation}
f(x) = \sum_{j=1}^k b_j(x)\beta_j
\label{eq:base funcion suavizado}
\end{equation}
Para ciertos parámetros $\beta_j$ a determinar.

**Base polinómica** \newline
Si consideramos la base $\mathcal{B}$ del espacio de polinomios de grado k, es decir, $\mathcal{B} = \{1, x_i, x_i^2, \dots, x_i^k \}$, la función de suavizado toma la forma: 
$$
f(x) = \beta_1 + \beta_2 x + \beta_3 x^2 + \dots + \beta_{k+1} x^k
$$
Y, por tanto, el modelo $\ref{eq: basic MAG}$ queda:
$$
y_i = \beta_1 + \beta_2 x_i + \beta_3 x_i^2 + \dots + \beta_{k+1} x_i^k + \epsilon_i
$$

\begin{observación}[Problema de la base polinómica]
Como indica Wood, 2017, p.162, por el teorema de Taylor, la base polinomial nos será útil cuando nuestro interés sea el de estudiar las propiedades de la función de suavizado en el entorno de un punto concreto, pero nos encontramos con problemas cuando queremos hacerlo en todo el dominio de $f$.

El principal problema se debe a que la interpolación de los datos puede resultar en una función muy oscilante o que no ajuste bien la indormación, dependiendo del valor de k. Esto se puede solucionar de cierta manera con el siguiente tipo de base de funciones.
\end{observación}

**Base lineal por parte** \newline
Consideremos ahora una partición de nodos $\{x^*_j : j = 1,\dots,k \}$ del rango de la variable predictora $x$ tal que $x^*_j > x^*_{j+1}$ y la base de funciones $\mathcal{B} = \{b_j(x)\}_{j=1}^k$ donde:


$$
b_1(x) = \left\{
\begin{array}{ l }
\frac {x^*_2 - x} {x^*_2 - x^*_1} \hspace{0.5cm}, si \hspace{0.2cm} x < x^*_2  \\
0 \hspace{0.5cm} c.c.
\end{array}
\right. 
$$
$$
b_j(x) = \left\{
\begin{array}{ l }
\frac {x - x^*_{j-1}} {x^*_j - x^*_{j-1}} \hspace{0.5cm}, si \hspace{0.2cm} x^*_{j-1}<x < x^*_j  \\
\frac {x^*_{j+1} - x} {x^*_{j+1} - x^*_j} \hspace{0.5cm}, si \hspace{0.2cm} x^*_{j}<x < x^*_{j+1} \\
0 \hspace{0.5cm} c.c
\end{array}
\right.
$$

$$
b_k(x) = \left\{
\begin{array}{ l }
\frac {x - x^*_{k-1}} {x^*_k - x^*_{k-1}} \hspace{0.5cm}, si \hspace{0.2cm} x > x^*_{k-1}  \\
0 \hspace{0.5cm} c.c.
\end{array}
\right. 
$$

\begin{ejemplo}
Supongamos que el rango de $x$ es de 0 a 5 y consideremos 6 nodos: $\{0,1,2,3,4,5\}$, entonces podemos representar las funciones $b_0(x)$, $b_2(x)$ y $b_5(x)$ como:
```{r}
b1 <- function(x) {
  ifelse(x < 1, 1-x, 0)
}

b2 <- function(x) {
  ifelse(1< x & x < 2, x-1, ifelse(2<x & x<3,3-x,0))
}

b5 <- function(x){
  ifelse(x > 4, x-4, 0)
}

x <- seq(0, 5, length.out = 100)
y1 <- b1(x)
y2 <- b2(x)
y5 <- b5(x)

par(mfrow = c(1, 3))

plot(x, y1, type = "l", col = "blue", main = "Función básica b1(x)")
abline(v = 0, lty = 2, col = "green")
points(0, 0, col = "red", pch = 16)
text(0, 0, "x1", pos = 3)
plot(x, y2, type = "l", col = "blue", main = "Función básica b2(x)")
abline(v = 2, lty = 2, col = "green")
points(2, 0, col = "red", pch = 16)
text(2, 0, "x2", pos = 3)
plot(x, y5, type = "l", col = "blue", main = "Función básica b5(x)")
abline(v = 5, lty = 2, col = "green")
points(5, 0, col = "red", pch = 16)
text(5, 0, "x5", pos = 3)

```
\end{ejemplo}